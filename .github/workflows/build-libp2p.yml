name: Build cpp-libp2p

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-libp2p.yml'

jobs:
  build-libp2p:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libssl-dev \
            libboost-all-dev \
            libfmt-dev \
            python3
      
      - name: Clone cpp-libp2p
        run: |
          git clone https://github.com/libp2p/cpp-libp2p.git libp2p-src
          cd libp2p-src
          git checkout master
      
      - name: Build cpp-libp2p
        run: |
          mkdir -p libp2p-src/build
          cd libp2p-src/build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/libp2p-install \
                ..
          make -j$(nproc)
          cmake --install .
      
      - name: Copy Hunter dependencies
        run: |
          # Find Hunter root (usually ~/.hunter)
          HUNTER_ROOT=$(find ~ -type d -name ".hunter" 2>/dev/null | head -1)
          if [ -n "$HUNTER_ROOT" ]; then
            echo "Hunter root: $HUNTER_ROOT"
            
            # Find and copy all header-only dependencies from Hunter
            for pkg in qtils scale soralog; do
              PKG_DIR=$(find $HUNTER_ROOT -type d -path "*/include/$pkg" 2>/dev/null | head -1)
              if [ -n "$PKG_DIR" ]; then
                cp -r "$PKG_DIR" ${{ github.workspace }}/libp2p-install/include/
                echo "Copied $pkg headers from: $PKG_DIR"
              else
                echo "Warning: $pkg headers not found"
              fi
            done
            
            # List what we have
            echo "Contents of libp2p-install/include:"
            ls -la ${{ github.workspace }}/libp2p-install/include/
          fi
      
      - name: Package libp2p
        run: |
          cd ${{ github.workspace }}
          tar -czf libp2p-artifact.tar.gz libp2p-install/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libp2p-build-ubuntu-latest
          path: libp2p-artifact.tar.gz
          retention-days: 90
